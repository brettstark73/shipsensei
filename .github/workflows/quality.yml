name: Quality Checks

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  quality:
    runs-on: ubuntu-latest

    # Database service for Prisma tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Prisma
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.prisma
            ~/.cache/prisma
          key: ${{ runner.os }}-prisma-${{ hashFiles('**/schema.prisma') }}
          restore-keys: |
            ${{ runner.os }}-prisma-

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            echo "No package-lock.json found; running npm install"
            npm install
          fi

      - name: Setup Prisma
        run: |
          echo "ğŸ—„ï¸ Setting up Prisma database for testing..."

          # Generate Prisma Client
          echo "ğŸ“¦ Generating Prisma Client..."
          npx prisma generate

          # Run database migrations
          echo "ğŸ”„ Running database migrations..."
          npx prisma migrate deploy

          # Verify database connection
          echo "âœ… Verifying database connection..."
          npx prisma db execute --stdin <<< "SELECT 1;"

          echo "ğŸ‰ Database setup complete!"
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      - name: Verify dependency integrity
        run: |
          echo "ğŸ” Verifying dependency integrity..."
          # Verify package-lock.json integrity hashes
          if [ -f package-lock.json ]; then
            npm ci --dry-run --prefer-offline
            echo "âœ… Dependency integrity verified"
          else
            echo "âš ï¸ No package-lock.json found - skipping integrity verification"
          fi

          # Check for known vulnerabilities in dependencies
          echo "ğŸ” Checking for vulnerable dependencies..."
          npm audit --audit-level=moderate || true

          # Verify npm package signatures (Node.js 16+)
          if command -v npm &> /dev/null; then
            echo "âœï¸ Verifying npm package signatures..."
            npm audit signatures || echo "âš ï¸ Signature verification not available or failed"
          fi

      - name: Prettier check
        run: npm run format:check

      - name: ESLint
        run: npx eslint . --ext .js,.jsx,.ts,.tsx,.html --max-warnings=0

      - name: Stylelint
        run: npx stylelint "**/*.{css,scss,sass,less,pcss}" --allow-empty-input

      - name: Run tests
        run: npm run test:ci
        env:
          CI: true
          NODE_ENV: test
          # SECURITY: All secrets use GitHub Secrets with safe fallbacks
          # Configure GitHub Secrets in repository settings for production values
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'test-secret-key-for-ci' }}
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          DIRECT_DATABASE_URL: postgresql://test:test@localhost:5432/test
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || 'test-key' }}
          ANTHROPIC_MODEL: claude-3-5-sonnet-20241022
          GITHUB_CLIENT_ID: ${{ secrets.GITHUB_CLIENT_ID || 'test-client-id' }}
          GITHUB_CLIENT_SECRET: ${{ secrets.GITHUB_CLIENT_SECRET || 'test-client-secret' }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID || 'test-google-id' }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET || 'test-google-secret' }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

      - name: Security audit
        run: npm audit --audit-level high

      - name: Check for hardcoded secrets
        run: |
          # Check for common secret patterns (excluding docs, tests, and workflow files)
          if grep -r -E "(password|secret|key|token).*[=:].*['\"][^'\"]{8,}" . \
               --exclude-dir=node_modules \
               --exclude-dir=.git \
               --exclude-dir=.github \
               --exclude-dir=tests \
               --exclude="*.md" \
               --exclude="package.json" || \
             grep -r -E "-----BEGIN.*KEY-----" . \
               --exclude-dir=node_modules \
               --exclude-dir=.git \
               --exclude-dir=.github \
               --exclude-dir=tests; then
            echo "âŒ Potential hardcoded secrets found"
            exit 1
          else
            echo "âœ… No hardcoded secrets detected"
          fi

      - name: Security pattern detection
        run: |
          # Check for XSS vulnerability patterns from WFHroulette
          echo "ğŸ” Scanning for XSS vulnerability patterns..."

          # Check for innerHTML with interpolation (dangerous pattern)
          if grep -r -E "innerHTML.*\\\$\{" . --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules; then
            echo "âŒ Potential XSS: innerHTML with template literal interpolation found"
            exit 1
          fi

          # Check for eval with interpolation
          if grep -r -E "eval\\\(.*\\\$\{" . --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules; then
            echo "âŒ Potential code injection: eval with interpolation found"
            exit 1
          fi

          # Check for document.write with interpolation
          if grep -r -E "document\\\\.write.*\\\$\{" . --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules; then
            echo "âŒ Potential XSS: document.write with interpolation found"
            exit 1
          fi

          # Check for onclick handlers with interpolation
          if grep -r -E "onclick.*=.*['\"].*\\\$\{" . --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" --include="*.html" --exclude-dir=node_modules; then
            echo "âŒ Potential XSS: onclick handler with interpolation found"
            exit 1
          fi

          echo "âœ… No XSS vulnerability patterns detected"

      - name: Input validation check
        run: |
          # Check for proper input validation patterns
          echo "ğŸ” Checking for input validation patterns..."

          # Set pipefail to catch grep failures properly
          set -o pipefail

          # Look for unvalidated user inputs in common patterns
          if grep -r -E "(req\\.query|req\\.params|req\\.body)\\.[a-zA-Z_][a-zA-Z0-9_]*[^\\.]" . --include="*.js" --include="*.ts" --exclude-dir=node_modules | grep -v -E "(trim|toLowerCase|toUpperCase|parseInt|parseFloat|Number\\.isNaN|String|Boolean)" > /tmp/unvalidated_inputs.txt 2>/dev/null && [ -s /tmp/unvalidated_inputs.txt ]; then
            echo "âš ï¸ Found potential unvalidated user inputs (review manually):"
            head -5 /tmp/unvalidated_inputs.txt
            echo "This is a warning, not a failure. Review these patterns manually."
          else
            echo "âœ… No unvalidated user inputs detected"
          fi

          # Clean up temp file
          rm -f /tmp/unvalidated_inputs.txt

      - name: Configuration security check
        run: |
          # Run comprehensive configuration security validation
          echo "ğŸ” Running configuration security validation..."
          npx create-quality-automation@latest --security-config

      - name: Documentation validation
        run: |
          # Run comprehensive documentation validation
          echo "ğŸ“– Running documentation validation..."
          npx create-quality-automation@latest --validate-docs

      - name: Lighthouse CI
        run: |
          # Only run Lighthouse CI if configuration exists
          if [ -f ".lighthouserc.js" ] || [ -f ".lighthouserc.json" ] || [ -f "lighthouserc.js" ]; then
            echo "ğŸš¢ Running Lighthouse CI..."
            npx lhci autorun
          else
            echo "â­ï¸ No Lighthouse CI configuration found, skipping"
          fi
        continue-on-error: true

      # NOTE: The "Test README Quick Start Instructions" step has been removed
      # because it relies on setup.js which only exists in the create-quality-automation
      # package itself, not in consumer repositories that copy this workflow.
      #
      # Consumer projects get the quality checks above (prettier, eslint, stylelint, etc.)
      # but don't need to test the installation process.

name: CLAUDE.md Validation

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'CLAUDE.md'
      - 'package.json'
      - 'scripts/validate-claude-md.js'
      - '.github/workflows/claude-md-validation.yml'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'CLAUDE.md'
      - 'package.json'
      - 'scripts/validate-claude-md.js'
      - '.github/workflows/claude-md-validation.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  validate-claude-md:
    runs-on: ubuntu-latest
    name: Validate CLAUDE.md Consistency

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Validate CLAUDE.md
        run: |
          echo "üîç Running CLAUDE.md validation..."
          node scripts/validate-claude-md.js

      - name: Check CLAUDE.md formatting
        run: |
          echo "üìù Checking CLAUDE.md formatting with Prettier..."
          npx prettier --check CLAUDE.md

      - name: Validate against package.json
        run: |
          echo "üîó Cross-checking CLAUDE.md with package.json..."

          # Extract package name from package.json
          PACKAGE_NAME=$(node -e "console.log(require('./package.json').name)")

          # Check if package name is mentioned in CLAUDE.md
          if ! grep -q "$PACKAGE_NAME" CLAUDE.md; then
            echo "‚ùå Package name '$PACKAGE_NAME' not found in CLAUDE.md"
            exit 1
          fi

          echo "‚úÖ Package name reference validated"

      - name: Check for TODO markers
        run: |
          echo "üîç Checking for unresolved TODO markers..."

          if grep -i "TODO\|FIXME\|XXX" CLAUDE.md; then
            echo "‚ö†Ô∏è Found TODO markers in CLAUDE.md - consider resolving them"
            exit 1
          else
            echo "‚úÖ No TODO markers found"
          fi

      - name: Validation summary
        if: success()
        run: |
          echo ""
          echo "‚úÖ CLAUDE.md validation successful!"
          echo ""
          echo "All checks passed:"
          echo "  ‚úì Structure and required sections"
          echo "  ‚úì Package references"
          echo "  ‚úì Script documentation"
          echo "  ‚úì Formatting"
          echo "  ‚úì No TODO markers"
          echo ""

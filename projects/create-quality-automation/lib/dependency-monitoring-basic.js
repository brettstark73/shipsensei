/**
 * Basic Dependency Monitoring Library (Free Tier)
 * Generates simple Dependabot configuration without advanced features
 */

/* eslint-disable security/detect-non-literal-fs-filename */

const fs = require('fs')
const path = require('path')

/**
 * Detect if project has package.json (npm projects only for free tier)
 */
function hasNpmProject(projectPath) {
  return fs.existsSync(path.join(projectPath, 'package.json'))
}

/**
 * Generate basic Dependabot configuration (Free Tier)
 * Limited to npm only, no framework detection, basic settings
 */
function generateBasicDependabotConfig(options = {}) {
  const {
    projectPath = '.',
    schedule = 'weekly',
    day = 'monday',
    time = '09:00',
  } = options

  if (!hasNpmProject(projectPath)) {
    return null // Only npm projects supported in free tier
  }

  const config = {
    version: 2,
    updates: [
      {
        'package-ecosystem': 'npm',
        directory: '/',
        schedule: {
          interval: schedule,
          day: day,
          time: time,
        },
        'open-pull-requests-limit': 5,
        labels: ['dependencies'],
        'commit-message': {
          prefix: 'deps',
          include: 'scope',
        },
        // Note: Dependabot will create PRs for all dependency updates.
        // To auto-merge specific updates (e.g., security patches), add a GitHub Actions
        // workflow with conditions like: if: contains(github.event.pull_request.labels.*.name, 'security')
        // See: https://docs.github.com/en/code-security/dependabot/working-with-dependabot/automating-dependabot-with-github-actions
      },
      // GitHub Actions monitoring (free tier includes this)
      {
        'package-ecosystem': 'github-actions',
        directory: '/',
        schedule: {
          interval: schedule,
          day: day,
          time: time,
        },
        labels: ['dependencies', 'github-actions'],
        'commit-message': {
          prefix: 'deps(actions)',
        },
      },
    ],
  }

  return config
}

/**
 * Write basic Dependabot configuration to file
 */
function writeBasicDependabotConfig(config, outputPath) {
  const yamlContent = `# Basic Dependabot configuration (Free Tier)
# Auto-generated by create-quality-automation
# Upgrade to Pro for framework-aware grouping and multi-language support
# See: https://create-quality-automation.dev/pro

${convertToYaml(config)}`

  const configDir = path.dirname(outputPath)
  if (!fs.existsSync(configDir)) {
    fs.mkdirSync(configDir, { recursive: true })
  }

  fs.writeFileSync(outputPath, yamlContent)
}

/**
 * Simple YAML converter (basic implementation)
 */
function convertToYaml(obj, indent = 0) {
  const spaces = ' '.repeat(indent)
  let yaml = ''

  if (Array.isArray(obj)) {
    obj.forEach(item => {
      if (typeof item === 'object' && item !== null) {
        yaml += `${spaces}- ${convertToYaml(item, indent + 2).trim()}\n`
      } else {
        yaml += `${spaces}- ${item}\n`
      }
    })
  } else if (typeof obj === 'object' && obj !== null) {
    Object.entries(obj).forEach(([key, value]) => {
      if (Array.isArray(value)) {
        yaml += `${spaces}${key}:\n`
        yaml += convertToYaml(value, indent + 2)
      } else if (typeof value === 'object' && value !== null) {
        yaml += `${spaces}${key}:\n`
        yaml += convertToYaml(value, indent + 2)
      } else {
        yaml += `${spaces}${key}: ${value}\n`
      }
    })
  }

  return yaml
}

module.exports = {
  hasNpmProject,
  generateBasicDependabotConfig,
  writeBasicDependabotConfig,
}
